<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NFR Proto1</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>NFR Proto1</h1>
      <p>FastAPI scaffold with a Jinja2-served frontend.</p>

      <nav class="pill-nav" role="navigation" aria-label="Primary">
        <button type="button" class="pill pill--taxonomy" data-path="/taxonomy">Taxonomy</button>
        <button type="button" class="pill pill--regulations" data-path="/regulations">Regulations</button>
        <button type="button" class="pill pill--obligations" data-path="/obligations">Obligations</button>
        <button type="button" class="pill pill--muted" disabled>4</button>
        <button type="button" class="pill pill--muted" disabled>5</button>
        <button type="button" class="pill pill--muted" disabled>6</button>
      </nav>

      <section id="health">
        <strong>API status:</strong> <span id="status">checking…</span>
      </section>

      <main id="content">
        <div class="welcome">
          <h2>Welcome</h2>
          <p>Select a section from the navigation above. Content will load here.</p>
        </div>
      </main>
    </div>

    <script>
      // Health check
      fetch('/api/health').then(r => r.json()).then(j => {
        document.getElementById('status').textContent = j.status || JSON.stringify(j)
      }).catch(e => {
        document.getElementById('status').textContent = 'error'
      })

      // Load fragments into #content and manage history
      (function (){
        const content = document.getElementById('content')
        if (!content) {
          document.body.innerHTML += '<div style="position:fixed;top:0;left:0;background:red;color:white;padding:1rem;z-index:9999">ERROR: content not found</div>'
          return
        }
        
        // Immediate visual test - change welcome message
        content.innerHTML = '<div class="welcome" style="border: 3px solid green; padding: 1rem;"><h2>✅ JavaScript IS Working!</h2><p>Click a pill button above to load content.</p></div>'

        async function loadFragment(path, push=true){
          console.log('loadFragment called with path:', path)
          // Show an immediate placeholder so the user sees feedback
          const name = path.replace(/\/+$/, '').split('/').filter(Boolean).pop() || 'section'
          const title = name.charAt(0).toUpperCase() + name.slice(1)
          console.log('Setting content banner for:', title)
          // show a prominent banner immediately so the user sees which menu was selected
          content.innerHTML = `<div class="content-banner content-banner--${name}"><div class="content-banner__inner"><h2>${title}</h2><p class="muted">Loading…</p></div></div>`
          console.log('Content innerHTML set to banner')
          setActive(path)

          // path expected like '/taxonomy' -> fetch '/taxonomy/fragment'
          const fragUrl = path.replace(/\/$/, '') + '/fragment'
          console.log('Fetching fragment from:', fragUrl)
          try {
            const res = await fetch(fragUrl, { headers: { 'X-Requested-With': 'fetch' } })
            console.log('Fragment response status:', res.status, res.ok)
            if (!res.ok) throw new Error(res.statusText)
            const html = await res.text()
            console.log('Fragment HTML received, length:', html.length)
            content.innerHTML = html
            console.log('Content innerHTML updated with fragment')
            if (push) history.pushState({ path }, '', path)
          } catch (err) {
            console.error('Fragment load error:', err)
            content.innerHTML = `<div class="error">Failed to load content: ${err.message}</div>`
          }
        }

        // Hook pill nav clicks
        // Handle pill clicks (buttons or anchors). Buttons use data-path.
        document.querySelectorAll('.pill-nav .pill').forEach(el => {
          console.log('Binding click to pill:', el.textContent, el.dataset.path)
          el.addEventListener('click', function(ev){
            console.log('Pill clicked:', el.textContent, 'disabled:', el.disabled)
            // disabled buttons should do nothing
            if (el.disabled) return
            const path = el.dataset.path || (el.getAttribute && el.getAttribute('href')) || null
            console.log('Path extracted:', path)
            if (path && path.startsWith('/')){
              ev.preventDefault()
              loadFragment(path)
            }
          })
        })

        // Toggle active pill and set aria state
        function setActive(path){
          document.querySelectorAll('.pill-nav .pill').forEach(el => {
            const p = el.dataset.path || (el.getAttribute && el.getAttribute('href')) || ''
            if (p === path) {
              el.classList.add('pill--active')
              el.setAttribute('aria-pressed', 'true')
            } else {
              el.classList.remove('pill--active')
              el.setAttribute('aria-pressed', 'false')
            }
          })
        }

        // Handle browser navigation
        window.addEventListener('popstate', (ev) => {
          const path = (ev.state && ev.state.path) || window.location.pathname
          if (path && (path.startsWith('/taxonomy') || path.startsWith('/regulations') || path.startsWith('/obligations'))) {
            loadFragment(path, false)
          } else {
            // load default welcome
            content.innerHTML = `<div class="welcome"><h2>Welcome</h2><p>Select a section from the navigation above. Content will load here.</p></div>`
          }
        })

        // Optionally load initial fragment if landing on one of the routes
        const initial = window.location.pathname
        if (initial && (initial.startsWith('/taxonomy') || initial.startsWith('/regulations') || initial.startsWith('/obligations'))){
          loadFragment(initial, false)
        } else {
          // ensure no pill is active on the welcome page
          setActive('')
        }

        // Expose loader globally (for debugging or inline handlers)
        window.__loadFragment = loadFragment

        // Delegate clicks as a fallback in case direct binding failed
        document.addEventListener('click', function(e){
          const btn = e.target.closest && e.target.closest('.pill')
          if (!btn) return
          console.log('Delegated click on pill:', btn.textContent)
          if (btn.disabled) return
          const path = btn.dataset.path || (btn.getAttribute && btn.getAttribute('href')) || null
          console.log('Delegated path:', path)
          if (path && path.startsWith('/')){
            e.preventDefault()
            loadFragment(path)
          }
        })
      })()
    </script>
  </body>
</html>
